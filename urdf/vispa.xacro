<?xml version="1.0"?>
<!--
   Copyright (C) Airbus Defence and Space Ltd - All Rights Reserved
   Written by Mark Shilton <mark.shilton@airbus.com>, January 2021

This is the master VISPA AD model file, in form of a XACRO macro.
To build the URDF file, invoke:
  xacro vispa.xacro > vispa.urdf
Joint FORs are consistent with VISPA ARM specification .
Joint FOR locations as well as arm dimensions have been cross-checked with arm specification.
Joint torques have been taken from arm specification.
Element masses have been taken from arm specification; inertia matrices have been generated with Meshlab (TODO).
(see http://gazebosim.org/tutorials?tut=inertia&cat=build_robot)
The file conforms to ros_industrial recommndations (TODO)
(see http://wiki.ros.org/Industrial/Tutorials/Create%20a%20URDF%20for%20an%20Industrial%20Robot)
 -->
<robot xmlns:xacro="http://www.ros.org/wiki/xacro" name="vispa">


  <!-- Xacro constants -->

  <xacro:property name="C_PI" value="3.14159265359" />
  <xacro:property name="C_PI_2" value="${C_PI / 2}" />
  <xacro:property name="C_2_PI" value="${C_PI * 2}" />
  <xacro:property name="C_1_DEGREE" value="${C_PI/180}" />
  <!-- Full -C_PI to C_PI limits in a revolute joint confuses ros_control:
  	need to truncate position limits for joints with 360 degree rotation -->
  <xacro:property name="PI_LIMIT_MARGIN" value="1e-4" />
  <xacro:property name="C_PI_POS" value="${C_PI - PI_LIMIT_MARGIN}" />


  <xacro:property name="JOINT_TORQUE" value="50" /><!-- 50Nm -->
  <xacro:property name="JOINT_RATE" value="0.09395689" /><!-- 0.09395689 -->
  <xacro:property name="JOINT_RATIO" value="1" /><!-- Gear Ratio -->
   <xacro:property name="JOINT_MASS" value="1.5" /> <!--Kg-->

  <xacro:property name="LIMB_1_MASS" value="1.0" />
  <xacro:property name="LIMB_2_MASS" value="0.66" />

  <xacro:property name="ALM_BASE_MASS" value="0.627" />
  <xacro:property name="ALM_ELBOW_MASS" value="0.363" />
  <xacro:property name="ALM_WRIST_MASS" value="0.2" />

  <xacro:property name="JOINT_DAMPING" value="100" /><!-- 1e-3 -->


  <!-- Xacro macros -->

  <!-- Dummy inertial properties (all links apart from world must have it defined -->
  <xacro:macro name="default_inertial" params="mass iner">
    <inertial>
      <mass value="${mass}"/>
      <inertia ixx="${iner}" ixy="0" ixz="0" iyy="${iner}" iyz="0" izz="${iner}"/>
      <origin xyz="0 0 0" />
    </inertial>
  </xacro:macro>

  <!-- Used to approximate link inertia based on the link bounding box. -->
  <!-- Introduced because "real" inertia calculated with Meshlab broke Gazebo simulation. -->
  <xacro:macro name="box_inertia" params="mass x y z orig">
    <inertial>
      <mass value="${mass}"/>
      <inertia ixx="${(y * y + z * z) / 12}" ixy="0" ixz="0" iyy="${(x * x + z * z) / 12}" iyz="0" izz="${(x * x + y * y) / 12}"/>
      <origin xyz="${orig}" />
    </inertial>
  </xacro:macro>

  <!-- Standard ROS(-industrial) frames -->
  <!-- inertials not needed here -->
  <link name="base_link" />
  <link name="base" />
  <link name="world" />
  <!-- <link name="tool0">
    <xacro:box_inertia mass="0.1" x="0.1" y="0.1" z="0.1" orig="0 0 0" />
  </link> -->


  <!-- VISPA links -->

  <link name="link0">
    <visual>
      <geometry>
        <mesh filename="package://vispa_description/meshes/LINK_BASE.stl" scale="0.001 0.001 0.001"/> <!-- Needed to scale as CAD exported in mm but rviz comsumes in SI units i.e. metres-->
      </geometry>
    </visual>
    <collision>
      <geometry>
        <mesh filename="package://vispa_description/meshes/LINK_BASE_col.stl" scale="0.001 0.001 0.001"/>
      </geometry>
    </collision>
    <xacro:box_inertia mass="${ALM_BASE_MASS}" x="0.151000" y="0.150985" z="0.105000" orig="0 0 0.0" />
  </link>

  <link name="link1">
    <visual>
      <geometry>
        <mesh filename="package://vispa_description/meshes/LINK_0.stl" scale="0.001 0.001 0.001"/>
      </geometry>
    </visual>
    <collision>
      <geometry>
        <mesh filename="package://vispa_description/meshes/LINK_0_col.stl" scale="0.001 0.001 0.001"/>
      </geometry>
    </collision>
    <xacro:box_inertia mass="${JOINT_MASS}" x="0.118000" y="0.119000" z="0.291000" orig="0.0 -0.004173 0.032607" />
  </link>

  <link name="link2">
    <visual>
      <geometry>
        <mesh filename="package://vispa_description/meshes/LINK_1.stl" scale="0.001 0.001 0.001"/>
      </geometry>
    </visual>
    <collision>
      <geometry>
        <mesh filename="package://vispa_description/meshes/LINK_1_col.stl" scale="0.001 0.001 0.001"/>
      </geometry>
    </collision>
    <xacro:box_inertia mass="${JOINT_MASS + LIMB_1_MASS}" x="0.118000" y="1.057500" z="0.261000" orig="0.0 0.219495 0.063379" />
  </link>

  <link name="link3">
    <visual>
      <geometry>
        <mesh filename="package://vispa_description/meshes/LINK_2.stl" scale="0.001 0.001 0.001"/>
      </geometry>
    </visual>
    <collision>
      <geometry>
        <mesh filename="package://vispa_description/meshes/LINK_2_col.stl" scale="0.001 0.001 0.001"/>
      </geometry>
    </collision>
    <xacro:box_inertia mass="${JOINT_MASS + ALM_ELBOW_MASS}" x="0.097000" y="0.105000" z="0.165181" orig="0.0 0.003751 -0.066289" />
  </link>

  <link name="link4">
    <visual>
      <geometry>
        <mesh filename="package://vispa_description/meshes/LINK_3.stl" scale="0.001 0.001 0.001"/>
      </geometry>
    </visual>
    <collision>
      <geometry>
        <mesh filename="package://vispa_description/meshes/LINK_3_col.stl" scale="0.001 0.001 0.001"/>
      </geometry>
    </collision>
    <xacro:box_inertia mass="${JOINT_MASS + LIMB_2_MASS}" x="0.079473" y="0.161490" z="0.800000" orig="-0.000267 0.040905 0.237073" />
  </link>

  <link name="link5">
    <visual>
      <geometry>
        <mesh filename="package://vispa_description/meshes/LINK_4.stl" scale="0.001 0.001 0.001"/>
      </geometry>
    </visual>
    <collision>
      <geometry>
        <mesh filename="package://vispa_description/meshes/LINK_4_col.stl" scale="0.001 0.001 0.001"/>
      </geometry>
    </collision>
    <xacro:box_inertia mass="${JOINT_MASS}" x="0.078986" y="0.099503" z="0.138700" orig="0.0 0.003134 0.063172" />
  </link>

  <link name="link6">
    <visual>
      <geometry>
        <mesh filename="package://vispa_description/meshes/LINK_5.stl" scale="0.001 0.001 0.001"/>
      </geometry>
    </visual>
    <collision>
      <geometry>
      	<mesh filename="package://vispa_description/meshes/LINK_5_col.stl" scale="0.001 0.001 0.001"/>
      </geometry>
    </collision>
    <xacro:box_inertia mass="${JOINT_MASS + ALM_WRIST_MASS}" x="0.103988" y="0.104000" z="0.168745" orig="0.000244 0.0 0.084854" />
  </link>


  <!-- Standard ROS(-industrial) and Gazebo joints -->

   <joint name="base_link-link0" type="fixed">
  	<parent link="base_link" />
  	<child link="link0" />
  </joint>

  <joint name="base_link-base" type="fixed">
  	<parent link="base_link" />
  	<child link="base" />
  </joint>

  <joint name="world-base_link" type="fixed">
  	<parent link="world" />
  	<child link="base_link" />
  </joint> -->

  <!--<joint name="link6-tool0" type="fixed">
  	<parent link="link6" />
  	<child link="tool0" />
  	<origin xyz="0 0 0.1685" />
  </joint>
  -->

  <!-- VISPA joints -->
  <joint name="j01" type="revolute">
    <axis xyz="0 0 1" />
    <limit lower="${-C_PI_POS}" upper="${C_PI_POS}" velocity="${JOINT_RATE}" effort="${JOINT_TORQUE}" />
    <parent link="link0"/>
    <child link="link1"/>
    <origin xyz="0.0 0.0 0.0048" rpy="0 0 0" />
    <dynamics damping="${JOINT_DAMPING}" />
  </joint>

  <joint name="j12" type="revolute">
    <axis xyz="0 -1 0" />
    <limit lower="${-C_PI_2}" upper="${C_PI_2}" velocity="${JOINT_RATE}" effort="${JOINT_TORQUE}" />
    <parent link="link1"/>
    <child link="link2"/>
    <origin xyz="0.005 -0.075 0.135" rpy="0 ${-C_PI_2} 0" /> -->
    <dynamics damping="${JOINT_DAMPING}" />
  </joint>

  <joint name="j23" type="revolute">
    <axis xyz="0 1 0" />
    <limit lower="${-C_PI_POS}" upper="${C_PI_POS}" velocity="${JOINT_RATE}" effort="${JOINT_TORQUE}" />
    <parent link="link2"/>
    <child link="link3"/>
    <origin xyz="0.667 -0.022 0.0" rpy="0 0 0" />
    <dynamics damping="${JOINT_DAMPING}" />
  </joint>

  <joint name="j34" type="revolute">
    <axis xyz="-1 0 0" />
    <limit lower="${-C_PI_POS}" upper="${C_PI_POS}" velocity="${JOINT_RATE}" effort="${JOINT_TORQUE}" />
    <parent link="link3"/>
    <child link="link4"/>
    <origin xyz="-0.113 0.08 0.0" rpy="0 0 0" />
    <dynamics damping="${JOINT_DAMPING}" />
  </joint>

  <joint name="j45" type="revolute">
    <axis xyz="0 1 0" />
    <limit lower="${-C_PI_POS}" upper="${C_PI_POS}" velocity="${JOINT_RATE}" effort="${JOINT_TORQUE}" />
    <parent link="link4"/>
    <child link="link5"/>
    <origin xyz="-0.435 0.03 0.0" rpy="0 0 0" />
    <dynamics damping="${JOINT_DAMPING}" />
  </joint>

  <joint name="j56" type="revolute">
    <axis xyz="0 0 -1" />
    <limit lower="${-C_PI_POS}" upper="${C_PI_POS}" velocity="${JOINT_RATE}" effort="${JOINT_TORQUE}" />
    <parent link="link5"/>
    <child link="link6"/>
    <origin xyz="0.237 -0.021 0.0"  rpy="0 ${C_PI_2} 0" />
    <dynamics damping="${JOINT_DAMPING}" />
  </joint>


  <!-- Transmissions (ros_control) -->
  <transmission name="j01_t">
    <type>transmission_interface/SimpleTransmission</type>
    <joint name="j01">
      <hardwareInterface>EffortJointInterface</hardwareInterface>
    </joint>
    <actuator name="motor_j01">
    	<mechanicalReduction>${JOINT_RATIO}</mechanicalReduction>
    </actuator>
  </transmission>

  <transmission name="j12_t">
    <type>transmission_interface/SimpleTransmission</type>
    <joint name="j12">
      <hardwareInterface>EffortJointInterface</hardwareInterface>
    </joint>
    <actuator name="motor_j12">
    	<mechanicalReduction>${JOINT_RATIO}</mechanicalReduction>
    </actuator>
  </transmission>

  <transmission name="j23_t">
    <type>transmission_interface/SimpleTransmission</type>
    <joint name="j23">
      <hardwareInterface>EffortJointInterface</hardwareInterface>
    </joint>
    <actuator name="motor_j23">
    	<mechanicalReduction>${JOINT_RATIO}</mechanicalReduction>
    </actuator>
  </transmission>

  <transmission name="j34_t">
    <type>transmission_interface/SimpleTransmission</type>
    <joint name="j34">
      <hardwareInterface>EffortJointInterface</hardwareInterface>
    </joint>
    <actuator name="motor_j34">
    	<mechanicalReduction>${JOINT_RATIO}</mechanicalReduction>
    </actuator>
  </transmission>

  <transmission name="j45_t">
    <type>transmission_interface/SimpleTransmission</type>
    <joint name="j45">
      <hardwareInterface>EffortJointInterface</hardwareInterface>
    </joint>
    <actuator name="motor_j45">
    	<mechanicalReduction>${JOINT_RATIO}</mechanicalReduction>
    </actuator>
  </transmission>

  <transmission name="j56_t">
    <type>transmission_interface/SimpleTransmission</type>
    <joint name="j56">
      <hardwareInterface>EffortJointInterface</hardwareInterface>
    </joint>
    <actuator name="motor_j56">
    	<mechanicalReduction>${JOINT_RATIO}</mechanicalReduction>
    </actuator>
  </transmission>

</robot>
